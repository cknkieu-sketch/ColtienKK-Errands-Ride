<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ColtienKK Errands & Ride</title>
  <meta name="theme-color" content="#0d9488" />
  <meta name="description" content="Reliable errands and ride services in SE Iowa. Fast mobile booking." />
  <style>
    :root{
      --brand:#0d9488; /* teal-600 */
      --ink:#0f172a;   /* slate-900 */
      --muted:#475569; /* slate-600 */
      --bg:#f8fafc;    /* slate-50 */
      --card:#ffffff;
      --ring:#99f6e4;
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial}
    .wrap{max-width:680px;margin:0 auto;padding:16px}
    header{display:flex;align-items:center;gap:12px;margin:8px 0 18px}
    header .logo{width:44px;height:44px;border-radius:12px;background:var(--brand);display:grid;place-items:center;color:#fff;font-weight:700}
    h1{font-size:1.45rem;line-height:1.2;margin:0}
    .card{background:var(--card);border-radius:var(--radius);padding:16px;box-shadow:0 8px 24px rgba(2,6,23,.06);border:1px solid #e2e8f0}
    label{display:block;font-size:.9rem;color:var(--muted);margin:12px 0 6px}
    input, select, textarea{width:100%;padding:12px 14px;border-radius:14px;border:1px solid #cbd5e1;background:#fff;font-size:1rem}
    input:focus, select:focus, textarea:focus{outline:none;box-shadow:0 0 0 4px var(--ring)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .btn{appearance:none;border:none;border-radius:999px;background:var(--brand);color:#fff;padding:14px 18px;font-weight:700;font-size:1.05rem;cursor:pointer}
    .btn.secondary{background:#0f172a10;color:#0f172a}
    .tag{display:inline-block;background:#0d948810;color:#0d9488;border:1px solid #0d948833;padding:6px 10px;border-radius:999px;font-size:.8rem;font-weight:600}
    .muted{color:var(--muted)}
    .quoteBox{display:none;margin-top:12px;border:1px dashed #94a3b8;border-radius:14px;padding:12px}
    .tiny{font-size:.8rem}
    footer{margin:32px 0 18px;text-align:center;color:var(--muted);font-size:.9rem}
    .hidden{display:none !important}
    .section-title{font-weight:800;margin:8px 0 6px}
    .nav{display:flex;gap:8px;margin-bottom:12px}
    .nav a{font-weight:700;text-decoration:none;color:var(--muted)}
    .nav a.active{color:var(--brand)}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">KK</div>
      <div>
        <h1>ColtienKK Errands & Ride</h1>
        <div class="muted tiny">Fast, reliable rides and errands in SE Iowa</div>
      </div>
    </header>

    <nav class="nav">
      <a href="#home" id="tabHome" class="active">Book</a>
      <a href="#admin" id="tabAdmin">(hidden)</a>
    </nav>

    <!-- HOME / BOOKING -->
    <section id="home" class="card">
      <div class="tag">Mobile Booking</div>
      <p class="muted" style="margin:8px 0 14px">Get an instant quote before you commit. We’ll also email a confirmation to you.</p>

      <div class="section-title">Contact</div>
      <label>Full name</label>
      <input id="custName" placeholder="Your name" autocomplete="name" />
      <label>Mobile phone</label>
      <input id="custPhone" placeholder="(555) 555‑5555" autocomplete="tel" />
      <label>Email</label>
      <input id="custEmail" placeholder="you@email.com" autocomplete="email" />

      <div class="section-title">Service</div>
      <label>Service Type</label>
      <select id="serviceType">
        <option>Service Ride (Point to Point)</option>
        <option>Errands (Shopping, Pickup, Drop‑off)</option>
        <option>Delivery/Courier</option>
        <option>Other (describe)</option>
      </select>
      <label class="hidden" id="otherLabel">Describe</label>
      <textarea class="hidden" id="otherNote" rows="3" placeholder="Brief description..."></textarea>

      <div class="section-title">Pickup Address</div>
      <label>Street Address</label>
      <input id="pAddr" placeholder="123 Main St" />
      <div class="row">
        <div>
          <label>City</label>
          <input id="pCity" placeholder="Burlington" />
        </div>
        <div>
          <label>State</label>
          <select id="pState"></select>
        </div>
      </div>
      <label>ZIP</label>
      <input id="pZip" placeholder="52601" />

      <div class="section-title">Drop‑off Address</div>
      <label>Street Address</label>
      <input id="dAddr" placeholder="456 Oak Ave" />
      <div class="row">
        <div>
          <label>City</label>
          <input id="dCity" placeholder="Burlington" />
        </div>
        <div>
          <label>State</label>
          <select id="dState"></select>
        </div>
      </div>
      <label>ZIP</label>
      <input id="dZip" placeholder="52601" />

      <div class="section-title">Timing</div>
      <label>Requested Date</label>
      <input id="svcDate" type="date" />
      <label>Requested Time</label>
      <input id="svcTime" type="time" />
      <label>Waiting Time (beyond 10 min included)</label>
      <input id="waitExtra" type="number" step="1" min="0" value="0" />
      <div class="tiny muted">First 10 minutes included. Enter extra minutes you expect beyond that.</div>

      <label>Notes (optional)</label>
      <textarea id="notes" rows="3" placeholder="Gate codes, pickup instructions, item details, etc."></textarea>

      <div style="display:flex;gap:10px;margin-top:16px">
        <button class="btn" id="btnQuote">Get Quote</button>
        <button class="btn secondary hidden" id="btnReset">Reset</button>
      </div>

      <div id="quoteBox" class="quoteBox">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
          <strong>Estimated Quote</strong>
          <span class="tiny muted" id="quoteMeta"></span>
        </div>
        <div style="font-size:1.4rem;font-weight:900;margin:8px 0" id="quoteAmt">$0.00</div>
        <div class="tiny muted" id="quoteBreak"></div>
        <div style="display:flex;gap:10px;margin-top:10px">
          <button class="btn" id="btnBook">Confirm & Book</button>
          <button class="btn secondary" id="btnRecalc">Recalculate</button>
        </div>
      </div>
    </section>

    <!-- ADMIN / HIDDEN DEV PAGE -->
    <section id="admin" class="card hidden" aria-hidden="true">
      <div class="section-title">Hidden Dev / Admin</div>
      <p class="muted tiny">This page is hidden. Open with <code>#admin?key=YOUR_SECRET</code>. Values are saved to this device only.</p>

      <label>Admin Access Key (set or update)</label>
      <input id="adminKey" placeholder="Change this to your secret" />

      <div class="section-title">Business Profile</div>
      <label>Business name</label>
      <input id="bizName" value="ColtienKK Errands & Ride" />
      <label>Business email (receives bookings)</label>
      <input id="bizEmail" value="coltienkk@gmail.com" />

      <div class="section-title">Office Location (for base calc)</div>
      <label>Street</label>
      <input id="offAddr" value="2617 Evergreen Drive" />
      <div class="row">
        <div>
          <label>City</label>
          <input id="offCity" value="Burlington" />
        </div>
        <div>
          <label>State</label>
          <select id="offState"></select>
        </div>
      </div>
      <label>ZIP</label>
      <input id="offZip" value="52601" />

      <div class="section-title">Pricing</div>
      <label>Base fee (covers dispatch + first 3 miles + first 10 min)</label>
      <input id="baseFee" type="number" step="0.01" value="12" />
      <label>Per‑mile rate (beyond 3 miles)</label>
      <input id="perMile" type="number" step="0.01" value="1.80" />
      <label>Per‑minute waiting rate (beyond 10 min)</label>
      <input id="perWait" type="number" step="0.01" value="0.50" />

      <div class="section-title">Distance Provider</div>
      <label>Provider</label>
      <select id="distProvider">
        <option value="none">None (manual rough calc)</option>
        <option value="ors">OpenRouteService (Driving)</option>
        <option value="gdm">Google Distance Matrix</option>
      </select>
      <label>ORS API key (if using ORS)</label>
      <input id="orsKey" placeholder="eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6ImI5YzhhMzQ0NTVjZjRmYWJhMDgxZDUzODI3NTIwZjg5IiwiaCI6Im11cm11cjY0In0=" />
      <label>Google Maps API key (if using GDM)</label>
      <input id="gmKey" placeholder="paste your Google key" />

      <div class="section-title">Google Apps Script Endpoint</div>
      <label>Web App URL (paste from Apps Script deployment)</label>
      <input id="gasUrl" placeholder="https://script.google.com/macros/s/AKfycbzlzClFGfNnzfQZA6UcX7uFfWAvFd5gMwMkFFnsyHc7Pza4NbRfF9pY6nbU1j4lXEY1/exec" />

      <div class="section-title">Save</div>
      <button class="btn" id="btnSaveAdmin">Save Settings</button>
    </section>

    <footer>
      © <span id="year"></span> ColtienKK Errands & Ride — <span class="muted">Get there. Get it done.</span>
    </footer>
  </div>

<script>
// ---------- Helpers ----------
const $ = (id)=>document.getElementById(id);
const states = ["AL","AK","AZ","AR","CA","CO","CT","DE","FL","GA","HI","ID","IL","IN","IA","KS","KY","LA","ME","MD","MA","MI","MN","MS","MO","MT","NE","NV","NH","NJ","NM","NY","NC","ND","OH","OK","OR","PA","RI","SC","SD","TN","TX","UT","VT","VA","WA","WV","WI","WY"];
function fillStates(sel, def="IA"){ sel.innerHTML = states.map(s=>`<option ${s==="IA"&&sel.id!=="offState" ? (s===def?"selected":"") : (s===def?"selected":"")}>${s}</option>`).join("") }
["pState","dState","offState"].forEach(id=>fillStates($(id)));

// Defaults (can be changed in Admin)
const store = {
  key: localStorage.getItem("ckk_key")||"dev123", // change in Admin
  bizName: localStorage.getItem("ckk_biz")||"ColtienKK Errands & Ride",
  bizEmail: localStorage.getItem("ckk_bizEmail")||"coltienkk@gmail.com",
  offAddr: localStorage.getItem("ckk_offAddr")||"2617 Evergreen Drive",
  offCity: localStorage.getItem("ckk_offCity")||"Burlington",
  offState: localStorage.getItem("ckk_offState")||"IA",
  offZip: localStorage.getItem("ckk_offZip")||"52601",
  baseFee: parseFloat(localStorage.getItem("ckk_baseFee")||"12"),
  perMile: parseFloat(localStorage.getItem("ckk_perMile")||"1.80"),
  perWait: parseFloat(localStorage.getItem("ckk_perWait")||"0.50"),
  provider: localStorage.getItem("ckk_provider")||"none",
  orsKey: localStorage.getItem("ckk_orsKey")||"",
  gmKey: localStorage.getItem("ckk_gmKey")||"",
  gasUrl: localStorage.getItem("ckk_gasUrl")||""
};

// Put defaults into Admin UI
("adminKey" in window) && (document.getElementById("adminKey").value = store.key);
document.getElementById("bizName").value = store.bizName;
document.getElementById("bizEmail").value = store.bizEmail;
document.getElementById("offAddr").value = store.offAddr; document.getElementById("offCity").value = store.offCity; document.getElementById("offState").value = store.offState; document.getElementById("offZip").value = store.offZip;
document.getElementById("baseFee").value = store.baseFee; document.getElementById("perMile").value = store.perMile; document.getElementById("perWait").value = store.perWait;
document.getElementById("distProvider").value = store.provider; document.getElementById("orsKey").value = store.orsKey; document.getElementById("gmKey").value = store.gmKey;
document.getElementById("gasUrl").value = store.gasUrl;

// Save admin
document.getElementById("btnSaveAdmin").addEventListener("click", ()=>{
  localStorage.setItem("ckk_key", document.getElementById("adminKey").value.trim()||"dev123");
  localStorage.setItem("ckk_biz", document.getElementById("bizName").value.trim());
  localStorage.setItem("ckk_bizEmail", document.getElementById("bizEmail").value.trim());
  localStorage.setItem("ckk_offAddr", document.getElementById("offAddr").value.trim());
  localStorage.setItem("ckk_offCity", document.getElementById("offCity").value.trim());
  localStorage.setItem("ckk_offState", document.getElementById("offState").value);
  localStorage.setItem("ckk_offZip", document.getElementById("offZip").value.trim());
  localStorage.setItem("ckk_baseFee", parseFloat(document.getElementById("baseFee").value||0));
  localStorage.setItem("ckk_perMile", parseFloat(document.getElementById("perMile").value||0));
  localStorage.setItem("ckk_perWait", parseFloat(document.getElementById("perWait").value||0));
  localStorage.setItem("ckk_provider", document.getElementById("distProvider").value);
  localStorage.setItem("ckk_orsKey", document.getElementById("orsKey").value.trim());
  localStorage.setItem("ckk_gmKey", document.getElementById("gmKey").value.trim());
  localStorage.setItem("ckk_gasUrl", document.getElementById("gasUrl").value.trim());
  alert("Saved. Reload this page to apply.");
});

// Simple router for hidden admin
function route(){
  const hash = location.hash || "#home";
  ["home","admin"].forEach(id=>{document.getElementById(id).classList.add("hidden");});
  document.getElementById("tabHome").classList.remove("active"); document.getElementById("tabAdmin").classList.remove("active");
  if(hash.startsWith("#admin")){
    const qp = new URLSearchParams(hash.split("?")[1]||"");
    const key = qp.get("key")||"";
    if(key && key === (localStorage.getItem("ckk_key")||"dev123")){
      document.getElementById("admin").classList.remove("hidden"); document.getElementById("tabAdmin").classList.add("active");
    }else{
      document.getElementById("home").classList.remove("hidden"); document.getElementById("tabHome").classList.add("active");
      alert("Admin key required. Use #admin?key=YOUR_SECRET");
    }
  }else{
    document.getElementById("home").classList.remove("hidden"); document.getElementById("tabHome").classList.add("active");
  }
}
window.addEventListener("hashchange",route); route();

// Show/Hide other field
document.getElementById("serviceType").addEventListener("change", e=>{
  const isOther = e.target.value.startsWith("Other");
  document.getElementById("otherLabel").classList.toggle("hidden", !isOther);
  document.getElementById("otherNote").classList.toggle("hidden", !isOther);
});

// Quote calculation
document.getElementById("btnQuote").addEventListener("click", async ()=>{
  const distMi = await estimateMiles();
  const extraWait = Math.max(0, parseInt(document.getElementById("waitExtra").value||0));
  const base = store.baseFee;
  const perMile = store.perMile;
  const perWait = store.perWait;
  const addMiles = Math.max(0, distMi - 3);
  const total = base + (addMiles*perMile) + (extraWait*perWait);
  document.getElementById("quoteAmt").textContent = `$${total.toFixed(2)}`;
  document.getElementById("quoteMeta").textContent = isFinite(distMi) ? `${distMi.toFixed(1)} mi est.` : "distance not available";
  document.getElementById("quoteBreak").innerHTML = `Base $${base.toFixed(2)} + ${addMiles.toFixed(1)} mi × $${perMile.toFixed(2)} + ${extraWait} min × $${perWait.toFixed(2)}`;
  document.getElementById("quoteBox").style.display = "block";
  document.getElementById("btnReset").classList.remove("hidden");
});

document.getElementById("btnReset").addEventListener("click", ()=>{ location.reload(); });
document.getElementById("btnRecalc").addEventListener("click", ()=>document.getElementById("btnQuote").click());

document.getElementById("btnBook").addEventListener("click", async ()=>{
  const payload = collectPayload();
  if(!payload) return;
  if(!store.gasUrl){ alert("Missing Google Apps Script Web App URL in Admin."); return; }
  try {
    const res = await fetch(store.gasUrl, { method:"POST", mode:"cors", headers:{"Content-Type":"application/json"}, body: JSON.stringify(payload) });
    const json = await res.json();
    if(json && json.ok){
      alert("Booking received! A confirmation email has been sent.");
      location.reload();
    } else {
      alert("Submitted, but server did not confirm. Check Apps Script logs.");
    }
  } catch(err){
    console.error(err);
    alert("Network or server error. Please try again later.");
  }
});

function collectPayload(){
  const name = document.getElementById("custName").value.trim();
  const phone = document.getElementById("custPhone").value.trim();
  const email = document.getElementById("custEmail").value.trim();
  const stype = document.getElementById("serviceType").value;
  const other = document.getElementById("otherNote").value.trim();
  const p = {addr:document.getElementById("pAddr").value.trim(),city:document.getElementById("pCity").value.trim(),state:document.getElementById("pState").value,zip:document.getElementById("pZip").value.trim()};
  const d = {addr:document.getElementById("dAddr").value.trim(),city:document.getElementById("dCity").value.trim(),state:document.getElementById("dState").value,zip:document.getElementById("dZip").value.trim()};
  const dt = {date:document.getElementById("svcDate").value, time:document.getElementById("svcTime").value};
  const waitExtra = Math.max(0, parseInt(document.getElementById("waitExtra").value||0));
  const quote = document.getElementById("quoteAmt").textContent.replace(/[^0-9.]/g,"");
  if(!name || !phone || !email || !p.addr || !p.city || !p.state || !p.zip || !d.addr || !d.city || !d.state || !d.zip){
    alert("Please fill in contact, pickup, and drop‑off details.");
    return null;
  }
  const payload = {
    admin: { bizName: store.bizName, bizEmail: store.bizEmail },
    serviceType: stype,
    otherDesc: stype.startsWith("Other") ? other : "",
    pickup: p,
    dropoff: d,
    when: dt,
    waitExtra,
    office: { addr: store.offAddr, city: store.offCity, state: store.offState, zip: store.offZip },
    pricing: { base: store.baseFee, perMile: store.perMile, perWait: store.perWait },
    distanceProvider: store.provider,
    customer: { name, phone, email },
    notes: document.getElementById("notes").value.trim(),
    quote: parseFloat(quote||0),
    source: "mobile",
  };
  return payload;
}

async function estimateMiles(){
  const p = `${document.getElementById("pAddr").value}, ${document.getElementById("pCity").value}, ${document.getElementById("pState").value} ${document.getElementById("pZip").value}`.trim();
  const d = `${document.getElementById("dAddr").value}, ${document.getElementById("dCity").value}, ${document.getElementById("dState").value} ${document.getElementById("dZip").value}`.trim();
  const provider = store.provider;
  try{
    if(provider === "ors" && store.orsKey){
      // Geocode via ORS
      const enc = encodeURIComponent;
      const g1 = await fetch(`https://api.openrouteservice.org/geocode/search?api_key=${store.orsKey}&text=${enc(p)}`);
      const j1 = await g1.json();
      const [lng1,lat1] = j1.features?.[0]?.geometry?.coordinates||[];
      const g2 = await fetch(`https://api.openrouteservice.org/geocode/search?api_key=${store.orsKey}&text=${enc(d)}`);
      const j2 = await g2.json();
      const [lng2,lat2] = j2.features?.[0]?.geometry?.coordinates||[];
      if(!lat1||!lng1||!lat2||!lng2) throw new Error("Geocode failed");
      const body = { coordinates: [[lng1,lat1],[lng2,lat2]] };
      const r = await fetch("https://api.openrouteservice.org/v2/directions/driving-car",{method:"POST",headers:{"Content-Type":"application/json","Authorization":store.orsKey},body:JSON.stringify(body)});
      const jr = await r.json();
      const meters = jr?.routes?.[0]?.summary?.distance||0;
      return meters/1609.344;
    }
    if(provider === "gdm" && store.gmKey){
      const url = new URL("https://maps.googleapis.com/maps/api/distancematrix/json");
      url.searchParams.set("origins", p);
      url.searchParams.set("destinations", d);
      url.searchParams.set("key", store.gmKey);
      const r = await fetch(url);
      const j = await r.json();
      const m = j?.rows?.[0]?.elements?.[0]?.distance?.value||0; // meters
      return m/1609.344;
    }
  }catch(e){ console.warn("distance error", e); }
  // Fallback: rough local estimate (same city ~3mi)
  return 3; 
}

document.getElementById("year").textContent = new Date().getFullYear();
</script>
</body>
</html>
